<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>BPI - 更新状況</title>
<style>
body{font-family:system-ui,-apple-system,"Segoe UI",sans-serif;margin:24px;line-height:1.6}
.card{border:1px solid #ddd;border-radius:12px;padding:16px;max-width:720px}
small{color:#666}
pre{background:#f6f6f6;padding:12px;border-radius:10px;overflow:auto}
table{border-collapse:collapse;width:100%;margin-top:10px}
th,td{border-bottom:1px solid #eee;padding:8px;text-align:left;font-size:14px}
th{background:#fafafa}
.muted{color:#666;font-size:13px}
</style>
</head>
<body>
<h1>BPI – BOAT PRO INDEX</h1>
<div class="card">
  <h2>更新ステータス</h2>
  <p id="msg">読み込み中…</p>
  <small>data/status.json を表示しています</small>
  <pre id="raw"></pre>
</div>

<div class="card" style="margin-top:16px">
  <h2>ダウンロード概要（ベストエフォート）</h2>
  <div class="muted">data/summary.json / data/races_flat.json（APIの構造により 0 件のこともあります）</div>
  <div id="summary" class="muted" style="margin-top:8px">読み込み中…</div>
</div>
<script>
async function main(){
  try{
    const res = await fetch("./data/status.json", {cache:"no-store"});
    if(!res.ok) throw new Error("status.json が見つからない / 読めない");
    const j = await res.json();
    document.getElementById("msg").textContent =
      (j.ok ? "✅ 更新成功" : "❌ 更新失敗") + " / " + (j.updated_at || "") + " / " + (j.message || "");
    document.getElementById("raw").textContent = JSON.stringify(j, null, 2);
  }catch(e){
    document.getElementById("msg").textContent = "❌ " + e.message;
  }

  // summary
  try{
    const res2 = await fetch("./data/summary.json", {cache:"no-store"});
    if(!res2.ok) throw new Error("summary.json がまだありません（run_now.bat を実行してください）");
    const s = await res2.json();
    if(!Array.isArray(s) || s.length === 0){
      document.getElementById("summary").textContent = "summary は 0 件です（APIの構造上、抽出できない日がある）";
      return;
    }
    const rows = s.map(x => {
      const avg = (x.payout_avg_3t ?? "—");
      const max = (x.payout_max_3t ?? "—");
      return `<tr><td>${x.date}</td><td>${x.races_found}</td><td>${avg}</td><td>${max}</td></tr>`;
    }).join("");
    document.getElementById("summary").innerHTML = `
      <table>
        <thead><tr><th>日付</th><th>抽出レース数</th><th>3連単 平均払戻</th><th>3連単 最大払戻</th></tr></thead>
        <tbody>${rows}</tbody>
      </table>
      <div class="muted" style="margin-top:8px">※ 払戻が取れないJSONの場合は「—」になります</div>
    `;
  }catch(e){
    document.getElementById("summary").textContent = "❌ " + e.message;
  }
}
main();
</script>
</body>
</html>